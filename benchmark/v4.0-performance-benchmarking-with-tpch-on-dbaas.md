---
title: TiDB DBaaS TPC-H 10G 性能测试报告
category: benchmark
---

# TiDB DBaaS TPC-H 10G 性能测试报告

## 测试目的

测试 DBaaS 上 TiDB 在 OLAP 场景下 4.0 版本的性能。

## 测试环境

### 测试集群

High 配置，2 个 TiDB 节点、3 个 TiKV 节点、3 个 TiFlash。其中 TiKV 节点与 TiFlash 节点混合部署。

> **注意：**
>
> 4.0.0-rc.1 版本中，TiFlash 不支持新的[字符排序规则](/character-set-and-collation.md#排序规则支持)下的计算下推，此环境中关闭了新的字符排序规则。后续版本 TiFlash 会支持新的排序规则。
> 
> ```sql
> select VARIABLE_VALUE from mysql.tidb where VARIABLE_NAME='new_collation_enabled';
> +----------------+
> | VARIABLE_VALUE |
> +----------------+
> | False          |
> +----------------+
> ```

### TiDB 版本信息

|  组件名  |  版本号      | commit hash                                |
|---------|-------------|--------------------------------------------|
| TiDB    | v4.0.0-rc.1 | 7267747ae0ec624dffc3fdedb00f1ed36e10284b   |
| PD      | v4.0.0-rc.1 | 31dae220db6294f2dc2ec0df330892fe76e59edc   |
| TiKV    | v4.0.0-rc.1 | e26d1524044327df3976c4477fba253a88ba3afa   |
| TiFlash | v4.0.0-rc.1 | 2d30a83ffa9508fd0468a708cdb0579327f788da   |

## 运行测试

### 导入数据

使用以下命令安装 [TiUP](https://tiup.io/)：

```
curl --proto '=https' --tlsv1.2 -sSf https://tiup-mirrors.pingcap.com/install.sh | sh
```

使用下面 `tiup bench` 命令导入 TPC-H 10 数据。
该命令导入的同时，会给测试的表[创建 TiFlash 副本](/tiflash/use-tiflash.md#按表构建-tiflash-副本)。在完成数据导入后，该命令会自动对表进行 `analyze table` 操作，收集[统计信息](/statistics.md)，供 TiDB 优化器优化执行计划。

```bash
tiup bench tpch prepare \
    --host ${tidb_host} --port 4000 --db tpch_10 --password ${password} \
    --sf 10 \
    --tiflash \
    --analyze --tidb_build_stats_concurrency 8 --tidb_distsql_scan_concurrency 30
```

运行完之后，确认数据已经建立好 TiFlash 副本：

```sql
select * from information_schema.tiflash_replica;
+--------------+------------+----------+---------------+-----------------+-----------+----------+
| TABLE_SCHEMA | TABLE_NAME | TABLE_ID | REPLICA_COUNT | LOCATION_LABELS | AVAILABLE | PROGRESS |
+--------------+------------+----------+---------------+-----------------+-----------+----------+
| tpch_10      | nation     |       53 |             1 |                 |         1 |        1 |
| tpch_10      | part       |       59 |             1 |                 |         1 |        1 |
| tpch_10      | supplier   |       62 |             1 |                 |         1 |        1 |
| tpch_10      | partsupp   |       65 |             1 |                 |         1 |        1 |
| tpch_10      | region     |       56 |             1 |                 |         1 |        1 |
| tpch_10      | orders     |       72 |             1 |                 |         1 |        1 |
| tpch_10      | customer   |       68 |             1 |                 |         1 |        1 |
| tpch_10      | lineitem   |       75 |             1 |                 |         1 |        1 |
+--------------+------------+----------+---------------+-----------------+-----------+----------+
```

### 执行查询

本文会比较智能选择、TiKV 隔离读、TiFlash 隔离读等三种[读取模式](/tiflash/use-tiflash.md#使用-tidb-读取-tiflash)下的 TiDB 性能。使用 MySQL 客户端连接到 TiDB 集群，先优化[相关参数](/tiflash/tune-tiflash-performance.md#tidb-相关参数调优)以及设置读取的模式。

{{< copyable "sql" >}}

```sql
set @@session.tidb_allow_batch_cop = 1;
set @@session.tidb_opt_distinct_agg_push_down = 1;
set @@session.tidb_distsql_scan_concurrency = 30;
set @@session.tidb_opt_agg_push_down = 0;
-- 设置读取模式. 不同读取模式对应的值如下:
-- 智能选择:'tikv,tiflash', TiKV隔离读:'tikv', TiFlash隔离读:'tiflash'.
set @@session.tidb_isolation_read_engines = 'tikv,tiflash';
-- 可以通过以下语句确认当前变量值
select @@tidb_isolation_read_engines, @@tidb_allow_batch_cop, @@tidb_opt_distinct_agg_push_down, @@tidb_distsql_scan_concurrency, @@tidb_opt_agg_push_down;
```

```sql
+-------------------------------+------------------------+-----------------------------------+---------------------------------+--------------------------+
| @@tidb_isolation_read_engines | @@tidb_allow_batch_cop | @@tidb_opt_distinct_agg_push_down | @@tidb_distsql_scan_concurrency | @@tidb_opt_agg_push_down |
+-------------------------------+------------------------+-----------------------------------+---------------------------------+--------------------------+
| tikv                          | 1                      | 1                                 | 30                              | 0                        |
+-------------------------------+------------------------+-----------------------------------+---------------------------------+--------------------------+
```

然后执行 TPC-H 的查询语句。你可以在这里找到具体的查询语句：[tidb-bench/tpch/queries](https://github.com/pingcap/tidb-bench/tree/master/tpch/queries)。

### 测试结果

| Query ID |  智能选择  |  TiKV 隔离读  |  TiFlash 隔离读  | 
|--------:|-----------:|------------:|--------------:|
| 1       |      2.63s |      13.67s |         2.69s |
| 2       |      2.50s |       2.88s |         2.43s |
| 3       |      4.39s |       6.96s |         4.39s |
| 4       |      2.77s |       3.65s |         5.88s |
| 5       |      7.68s |       8.48s |         7.60s |
| 6       |      0.56s |       3.02s |         0.58s |
| 7       |      3.67s |       5.28s |         3.73s |
| 8       |      7.50s |       6.03s |         7.88s |
| 9       |     26.05s |      26.88s |        26.13s |
| 10      |      3.72s |       4.30s |         3.80s |
| 11      |      1.92s |       2.05s |         1.98s |
| 12      |      1.38s |       4.67s |         1.37s |
| 13      |      6.31s |       6.98s |         6.24s |
| 14      |      0.93s |       3.95s |         0.97s |
| 15      |      1.26s |       5.51s |         1.25s |
| 16      |      2.00s |       2.11s |         1.35s |
| 17      |      8.22s |      16.44s |         7.99s |
| 18      |     27.94s |      28.30s |        27.56s |
| 19      |      3.07s |       4.87s |         3.09s |
| 20      |      1.27s |       3.55s |         8.20s |
| 21      |      7.82s |       7.86s |        18.23s |
| 22      |      2.79s |       3.45s |         2.75s |

![TPC-H Query Result](/media/tpch-query-result-v4.0-dbaas.png)

说明：

- 图中蓝色为智能选择，红色为 TiKV 隔离读，黄色为 TiFlash 隔离读，纵坐标是 Query 的处理时间，纵坐标越低，性能越好。
- 图中不显示 Query 18 结果，因为 4.0.0-rc.1 版本 TiDB 聚合算子在大数据量情况下消耗较多内存，Query 18 查询时会报错：`Lost connection to MySQL server during query`。相关 Issue 见 [tidb#14103](https://github.com/pingcap/tidb/issues/14103)、[tidb#14413](https://github.com/pingcap/tidb/issues/14413)。
