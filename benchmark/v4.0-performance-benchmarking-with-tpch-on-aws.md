---
title: TiDB on AWS EC2 TPC-H 10G 性能对比测试报告 - v4.0 对比 v3.0
category: benchmark
---

# TiDB on AWS EC2 TPC-H 10G 性能对比测试报告 - v4.0 对比 v3.0

## 测试目的

对比 TiDB 4.0 版本和 3.0 版本在 OLAP 场景下 TPC-H 性能表现。

## 测试环境

### 测试集群

|      用途            | AWS 实例类型 |              操作系统镜像              | 数量 |
|---------------------|-------------|--------------------------------------|-----|
| 部署 TiDB            | c5.4xlarge  | CentOS 7 (x86_64) - with Updates HVM |  2  |
| 部署 PD              | m5.xlarge   | CentOS 7 (x86_64) - with Updates HVM |  3  |
| 部署 TiKV 及 TiFlash | i3.4xlarge  | CentOS 7 (x86_64) - with Updates HVM |  3  |
| 中控机               | m5.xlarge   | CentOS 7 (x86_64) - with Updates HVM |  1  |

### TiDB 版本信息

TiDB 3.0

|  组件名  |  版本号      | commit hash                                |
|---------|-------------|--------------------------------------------|
| TiDB    |   v3.0.13   | e19f9229767090f6abf4d936ee6a60c0c7395373   |
| PD      |   v3.0.13   | 84c952ab9f3e9dfc5e7fa77566f4354967630ef8   |
| TiKV    |   v3.0.13   | 38c0e9308bb7f984c7003c18ba1f4079d8d4cc36   |

TiDB 4.0

|  组件名  |  版本号      | commit hash                                |
|---------|-------------|--------------------------------------------|
| TiDB    | v4.0.0-rc.1 | 7267747ae0ec624dffc3fdedb00f1ed36e10284b   |
| PD      | v4.0.0-rc.1 | 31dae220db6294f2dc2ec0df330892fe76e59edc   |
| TiKV    | v4.0.0-rc.1 | e26d1524044327df3976c4477fba253a88ba3afa   |
| TiFlash | v4.0.0-rc.1 | 2d30a83ffa9508fd0468a708cdb0579327f788da   |

## 运行测试

### 准备集群硬件

为了避免 TiKV 及 TiFlash 磁盘 IO 资源上的争抢，把 AWS 实例带的两个 1.9T NVMe SSD 分别挂载为 `/data1` 及 `/data2`。 规划把 TiKV 的部署至 `/data1`，而 TiFlash 部署至 `/data2`。

首先对数据盘格式化为 ext4 文件系统，参考 [在部署目标机器上添加数据盘 EXT4 文件系统挂载参数](/production-deployment-using-tiup/#第-3-步在-tikv-部署目标机器上添加数据盘-ext4-文件系统挂载参数)。

### 部署集群

使用 TiUP 来部署集群，参考 [使用 TiUP 部署 TiDB 集群](/production-deployment-using-tiup.md)
使用以下命令安装 [TiUP](https://tiup.io/)：

```
curl --proto '=https' --tlsv1.2 -sSf https://tiup-mirrors.pingcap.com/install.sh | sh
```

参考 [配置文件模版 topology.yaml](/production-deployment-using-tiup/#配置文件模版-topologyyaml-1) 编辑部署拓扑文件。 注意 TiKV 部署至 `/data1`，TiFlash 部署至 `/data2`。

部署后使用 `tiup display <cluster-name>` 命令确认集群拓扑：

3.0 集群拓扑如下：

```
# tiup cluster display bench_3_0
Starting component `cluster`: /root/.tiup/components/cluster/v0.6.1/cluster display bench_3_0
TiDB Cluster: bench_3_0
TiDB Version: v3.0.13
ID                   Role          Host           Ports        OS/Arch       Status     Data Dir                      Deploy Dir
--                   ----          ----           -----        -------       ------     --------                      ----------
172.31.27.181:9593   alertmanager  172.31.27.181  9593/9594    linux/x86_64  Up         /tidb-data/alertmanager-9593  /tidb-deploy/alertmanager-9593
172.31.30.160:3500   grafana       172.31.30.160  3500         linux/x86_64  Up         -                             /tidb-deploy/grafana-3500
172.31.23.121:2879   pd            172.31.23.121  2879/2880    linux/x86_64  Healthy    /tidb-data/pd-2879            /tidb-deploy/pd-2879
172.31.27.181:2879   pd            172.31.27.181  2879/2880    linux/x86_64  Healthy    /tidb-data/pd-2879            /tidb-deploy/pd-2879
172.31.30.160:2879   pd            172.31.30.160  2879/2880    linux/x86_64  Healthy|L  /tidb-data/pd-2879            /tidb-deploy/pd-2879
172.31.23.121:9590   prometheus    172.31.23.121  9590         linux/x86_64  Up         /tidb-data/prometheus-8749    /tidb-deploy/prometheus-8749
172.31.19.167:4500   tidb          172.31.19.167  4500/10580   linux/x86_64  Up         -                             /tidb-deploy/tidb-4500
172.31.22.39:4500    tidb          172.31.22.39   4500/10580   linux/x86_64  Up         -                             /tidb-deploy/tidb-4500
172.31.38.213:20660  tikv          172.31.38.213  20660/20680  linux/x86_64  Up         /data1/tidb-data/tikv-20660   /tidb-deploy/tikv-20660
172.31.44.138:20660  tikv          172.31.44.138  20660/20680  linux/x86_64  Up         /data1/tidb-data/tikv-20660   /tidb-deploy/tikv-20660
172.31.44.186:20660  tikv          172.31.44.186  20660/20680  linux/x86_64  Up         /data1/tidb-data/tikv-20660   /tidb-deploy/tikv-20660
```

4.0 集群拓扑如下：

```
# tiup cluster display bench_4_0
Starting component `cluster`: /root/.tiup/components/cluster/v0.6.1/cluster display bench_4_0
TiDB Cluster: bench_4_0
TiDB Version: v4.0.0-rc.1
ID                   Role          Host           Ports                            OS/Arch       Status     Data Dir                       Deploy Dir
--                   ----          ----           -----                            -------       ------     --------                       ----------
172.31.27.181:9093   alertmanager  172.31.27.181  9093/9094                        linux/x86_64  Up         /tidb-data/alertmanager-9093   /tidb-deploy/alertmanager-9093
172.31.30.160:3000   grafana       172.31.30.160  3000                             linux/x86_64  Up         -                              /tidb-deploy/grafana-3000
172.31.23.121:2379   pd            172.31.23.121  2379/2380                        linux/x86_64  Healthy    /tidb-data/pd-2379             /tidb-deploy/pd-2379
172.31.27.181:2379   pd            172.31.27.181  2379/2380                        linux/x86_64  Healthy    /tidb-data/pd-2379             /tidb-deploy/pd-2379
172.31.30.160:2379   pd            172.31.30.160  2379/2380                        linux/x86_64  Healthy|L  /tidb-data/pd-2379             /tidb-deploy/pd-2379
172.31.23.121:9090   prometheus    172.31.23.121  9090                             linux/x86_64  Up         /tidb-data/prometheus-9090     /tidb-deploy/prometheus-9090
172.31.19.167:4000   tidb          172.31.19.167  4000/10080                       linux/x86_64  Up         -                              /tidb-deploy/tidb-4000
172.31.22.39:4000    tidb          172.31.22.39   4000/10080                       linux/x86_64  Up         -                              /tidb-deploy/tidb-4000
172.31.38.213:9000   tiflash       172.31.38.213  9000/8123/3930/20170/20292/8234  linux/x86_64  Up         /data2/tidb-data/tiflash-9000  /tidb-deploy/tiflash-9000
172.31.44.138:9000   tiflash       172.31.44.138  9000/8123/3930/20170/20292/8234  linux/x86_64  Up         /data2/tidb-data/tiflash-9000  /tidb-deploy/tiflash-9000
172.31.44.186:9000   tiflash       172.31.44.186  9000/8123/3930/20170/20292/8234  linux/x86_64  Up         /data2/tidb-data/tiflash-9000  /tidb-deploy/tiflash-9000
172.31.38.213:20160  tikv          172.31.38.213  20160/20180                      linux/x86_64  Up         /data1/tidb-data/tikv-20160    /tidb-deploy/tikv-20160
172.31.44.138:20160  tikv          172.31.44.138  20160/20180                      linux/x86_64  Up         /data1/tidb-data/tikv-20160    /tidb-deploy/tikv-20160
172.31.44.186:20160  tikv          172.31.44.186  20160/20180                      linux/x86_64  Up         /data1/tidb-data/tikv-20160    /tidb-deploy/tikv-20160
```

### 导入数据

使用下面 `tiup bench` 命令，分别向两个集群导入 TPC-H 10 数据。  
在完成数据导入后，该命令会自动对表进行 `analyze table` 操作，收集[统计信息](/statistics.md)，供 TiDB 优化器优化执行计划。  
其中 4.0 导入数据命令执行的同时，会给测试的表[创建 TiFlash 副本](/tiflash/use-tiflash.md#按表构建-tiflash-副本)。  

3.0 导入数据命令：

{{< copyable "bash" >}}

```bash
tiup bench tpch prepare \
    --host ${tidb_host} --port 4500 --db tpch_10 \
    --sf 10 \
    --analyze --tidb_build_stats_concurrency 8 --tidb_distsql_scan_concurrency 30
```

4.0 导入数据命令：

{{< copyable "bash" >}}

```bash
tiup bench tpch prepare \
    --host ${tidb_host} --port 4000 --db tpch_10 --password ${password} \
    --sf 10 \
    --tiflash \
    --analyze --tidb_build_stats_concurrency 8 --tidb_distsql_scan_concurrency 30
```

运行完之后，确认数据已经建立好 TiFlash 副本：

```sql
select * from information_schema.tiflash_replica;
+--------------+------------+----------+---------------+-----------------+-----------+----------+
| TABLE_SCHEMA | TABLE_NAME | TABLE_ID | REPLICA_COUNT | LOCATION_LABELS | AVAILABLE | PROGRESS |
+--------------+------------+----------+---------------+-----------------+-----------+----------+
| tpch_10      | nation     |       53 |             1 |                 |         1 |        1 |
| tpch_10      | part       |       59 |             1 |                 |         1 |        1 |
| tpch_10      | supplier   |       62 |             1 |                 |         1 |        1 |
| tpch_10      | partsupp   |       65 |             1 |                 |         1 |        1 |
| tpch_10      | region     |       56 |             1 |                 |         1 |        1 |
| tpch_10      | orders     |       72 |             1 |                 |         1 |        1 |
| tpch_10      | customer   |       68 |             1 |                 |         1 |        1 |
| tpch_10      | lineitem   |       75 |             1 |                 |         1 |        1 |
+--------------+------------+----------+---------------+-----------------+-----------+----------+
```

### 执行查询

因为 4.0 中新引入了 [TiFlash](/stable/tiflash/tiflash-overview.md) 组件增强 TiDB HTAP 形态。 本文会比较 3.0 与 4.0 仅读取 TiKV， 4.0 通过智能选择混合读取 TiKV、TiFlash 三者的性能。

使用 MySQL 客户端连接到 TiDB 集群，先优化[相关参数](/tiflash/tune-tiflash-performance.md#tidb-相关参数调优)，其中 4.0 版本还需要设置[读取模式](/tiflash/use-tiflash.md#使用-tidb-读取-tiflash)。

3.0 设置参数命令：

{{< copyable "sql" >}}

```sql
set @@session.tidb_distsql_scan_concurrency = 30;
set @@session.tidb_opt_agg_push_down = 0;
```

4.0 设置参数命令：

{{< copyable "sql" >}}

```sql
set @@session.tidb_allow_batch_cop = 1;
set @@session.tidb_opt_distinct_agg_push_down = 1;
set @@session.tidb_distsql_scan_concurrency = 30;
set @@session.tidb_opt_agg_push_down = 0;
-- 设置读取模式. 不同读取模式对应的值如下:
-- 智能选择:'tikv,tiflash', TiKV隔离读:'tikv'
set @@session.tidb_isolation_read_engines = 'tikv,tiflash';
-- 可以通过以下语句确认当前变量值
select @@tidb_isolation_read_engines, @@tidb_allow_batch_cop, @@tidb_opt_distinct_agg_push_down, @@tidb_distsql_scan_concurrency, @@tidb_opt_agg_push_down;
```

```sql
+-------------------------------+------------------------+-----------------------------------+---------------------------------+--------------------------+
| @@tidb_isolation_read_engines | @@tidb_allow_batch_cop | @@tidb_opt_distinct_agg_push_down | @@tidb_distsql_scan_concurrency | @@tidb_opt_agg_push_down |
+-------------------------------+------------------------+-----------------------------------+---------------------------------+--------------------------+
| tikv,tiflash                  | 1                      | 1                                 | 30                              | 0                        |
+-------------------------------+------------------------+-----------------------------------+---------------------------------+--------------------------+
```

然后执行 TPC-H 的查询语句。你可以在这里找到具体的查询语句：[tidb-bench/tpch/queries](https://github.com/pingcap/tidb-bench/tree/master/tpch/queries)。

### 测试结果

| Query ID |  3.0.13  |  4.0.0-rc.1  |  4.0.0-rc.1 with TiFlash replica  | 
|--------:|-----------:|------------:|--------------:|
| 1       |   10.90s   |      7.24s  |      2.09s    |
| 2       |    3.24s   |      1.91s  |      2.02s    |
| 3       |   13.91s   |      3.79s  |      4.16s    |
| 4       |    5.36s   |      3.06s  |      2.72s    |
| 5       |   20.36s   |      6.10s  |      7.18s    |
| 6       |    6.79s   |      2.61s  |      0.36s    |
| 7       |    8.91s   |      4.38s  |      3.44s    |
| 8       |    8.82s   |      6.85s  |      7.69s    |
| 9       |   33.54s   |     16.87s  |     17.19s    |
| 10      |    4.62s   |      3.45s  |      3.46s    |
| 11      |    3.98s   |      1.73s  |      1.64s    |
| 12      |    5.94s   |      3.56s  |      1.30s    |
| 13      |    7.17s   |      4.75s  |      4.30s    |
| 14      |    5.35s   |      3.00s  |      0.77s    |
| 15      |   12.19s   |      1.71s  |      1.27s    |
| 16      |    2.87s   |      2.59s  |      2.22s    |
| 17      |   20.66s   |     11.42s  |      7.20s    |
| 18      |   22.65s   |     20.47s  |     21.37s    |
| 19      |    6.10s   |      3.95s  |      2.83s    |
| 20      |    5.52s   |      2.22s  |      1.19s    |
| 21      |   12.48s   |      7.18s  |      7.24s    |
| 22      |    4.56s   |      2.74s  |      2.12s    |

![TPC-H Query Result](/media/tpch-query-result-v4.0-aws.png)

说明：

- 图中蓝色为 3.0.13，红色为 4.0.0-rc.1 (仅从 TiKV 读)，黄色为 4.0.0-rc.1 (从 TiKV、TiFlash 智能选取)，纵坐标是 Query 的处理时间，纵坐标越低，性能越好。
